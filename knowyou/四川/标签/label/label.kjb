<?xml version="1.0" encoding="UTF-8"?>
<job>
  <name>label</name>
  <description>四川各类标签</description>
  <extended_description>此ETL用于四川各类标签计算，结果均写入dmt库，运行时间未定</extended_description>
  <job_version />
  <job_status>0</job_status>
  <directory>/</directory>
  <created_user>-</created_user>
  <created_date>2021/09/22 10:20:41.544</created_date>
  <modified_user>-</modified_user>
  <modified_date>2021/09/22 10:20:41.544</modified_date>
  <parameters>
    </parameters>
  <slaveservers>
    </slaveservers>
  <job-log-table>
    <connection />
    <schema />
    <table />
    <size_limit_lines />
    <interval />
    <timeout_days />
    <field>
      <id>ID_JOB</id>
      <enabled>Y</enabled>
      <name>ID_JOB</name>
    </field>
    <field>
      <id>CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>CHANNEL_ID</name>
    </field>
    <field>
      <id>JOBNAME</id>
      <enabled>Y</enabled>
      <name>JOBNAME</name>
    </field>
    <field>
      <id>STATUS</id>
      <enabled>Y</enabled>
      <name>STATUS</name>
    </field>
    <field>
      <id>LINES_READ</id>
      <enabled>Y</enabled>
      <name>LINES_READ</name>
    </field>
    <field>
      <id>LINES_WRITTEN</id>
      <enabled>Y</enabled>
      <name>LINES_WRITTEN</name>
    </field>
    <field>
      <id>LINES_UPDATED</id>
      <enabled>Y</enabled>
      <name>LINES_UPDATED</name>
    </field>
    <field>
      <id>LINES_INPUT</id>
      <enabled>Y</enabled>
      <name>LINES_INPUT</name>
    </field>
    <field>
      <id>LINES_OUTPUT</id>
      <enabled>Y</enabled>
      <name>LINES_OUTPUT</name>
    </field>
    <field>
      <id>LINES_REJECTED</id>
      <enabled>Y</enabled>
      <name>LINES_REJECTED</name>
    </field>
    <field>
      <id>ERRORS</id>
      <enabled>Y</enabled>
      <name>ERRORS</name>
    </field>
    <field>
      <id>STARTDATE</id>
      <enabled>Y</enabled>
      <name>STARTDATE</name>
    </field>
    <field>
      <id>ENDDATE</id>
      <enabled>Y</enabled>
      <name>ENDDATE</name>
    </field>
    <field>
      <id>LOGDATE</id>
      <enabled>Y</enabled>
      <name>LOGDATE</name>
    </field>
    <field>
      <id>DEPDATE</id>
      <enabled>Y</enabled>
      <name>DEPDATE</name>
    </field>
    <field>
      <id>REPLAYDATE</id>
      <enabled>Y</enabled>
      <name>REPLAYDATE</name>
    </field>
    <field>
      <id>LOG_FIELD</id>
      <enabled>Y</enabled>
      <name>LOG_FIELD</name>
    </field>
    <field>
      <id>EXECUTING_SERVER</id>
      <enabled>N</enabled>
      <name>EXECUTING_SERVER</name>
    </field>
    <field>
      <id>EXECUTING_USER</id>
      <enabled>N</enabled>
      <name>EXECUTING_USER</name>
    </field>
    <field>
      <id>START_JOB_ENTRY</id>
      <enabled>N</enabled>
      <name>START_JOB_ENTRY</name>
    </field>
    <field>
      <id>CLIENT</id>
      <enabled>N</enabled>
      <name>CLIENT</name>
    </field>
  </job-log-table>
  <jobentry-log-table>
    <connection />
    <schema />
    <table />
    <timeout_days />
    <field>
      <id>ID_BATCH</id>
      <enabled>Y</enabled>
      <name>ID_BATCH</name>
    </field>
    <field>
      <id>CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>CHANNEL_ID</name>
    </field>
    <field>
      <id>LOG_DATE</id>
      <enabled>Y</enabled>
      <name>LOG_DATE</name>
    </field>
    <field>
      <id>JOBNAME</id>
      <enabled>Y</enabled>
      <name>TRANSNAME</name>
    </field>
    <field>
      <id>JOBENTRYNAME</id>
      <enabled>Y</enabled>
      <name>STEPNAME</name>
    </field>
    <field>
      <id>LINES_READ</id>
      <enabled>Y</enabled>
      <name>LINES_READ</name>
    </field>
    <field>
      <id>LINES_WRITTEN</id>
      <enabled>Y</enabled>
      <name>LINES_WRITTEN</name>
    </field>
    <field>
      <id>LINES_UPDATED</id>
      <enabled>Y</enabled>
      <name>LINES_UPDATED</name>
    </field>
    <field>
      <id>LINES_INPUT</id>
      <enabled>Y</enabled>
      <name>LINES_INPUT</name>
    </field>
    <field>
      <id>LINES_OUTPUT</id>
      <enabled>Y</enabled>
      <name>LINES_OUTPUT</name>
    </field>
    <field>
      <id>LINES_REJECTED</id>
      <enabled>Y</enabled>
      <name>LINES_REJECTED</name>
    </field>
    <field>
      <id>ERRORS</id>
      <enabled>Y</enabled>
      <name>ERRORS</name>
    </field>
    <field>
      <id>RESULT</id>
      <enabled>Y</enabled>
      <name>RESULT</name>
    </field>
    <field>
      <id>NR_RESULT_ROWS</id>
      <enabled>Y</enabled>
      <name>NR_RESULT_ROWS</name>
    </field>
    <field>
      <id>NR_RESULT_FILES</id>
      <enabled>Y</enabled>
      <name>NR_RESULT_FILES</name>
    </field>
    <field>
      <id>LOG_FIELD</id>
      <enabled>N</enabled>
      <name>LOG_FIELD</name>
    </field>
    <field>
      <id>COPY_NR</id>
      <enabled>N</enabled>
      <name>COPY_NR</name>
    </field>
  </jobentry-log-table>
  <channel-log-table>
    <connection />
    <schema />
    <table />
    <timeout_days />
    <field>
      <id>ID_BATCH</id>
      <enabled>Y</enabled>
      <name>ID_BATCH</name>
    </field>
    <field>
      <id>CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>CHANNEL_ID</name>
    </field>
    <field>
      <id>LOG_DATE</id>
      <enabled>Y</enabled>
      <name>LOG_DATE</name>
    </field>
    <field>
      <id>LOGGING_OBJECT_TYPE</id>
      <enabled>Y</enabled>
      <name>LOGGING_OBJECT_TYPE</name>
    </field>
    <field>
      <id>OBJECT_NAME</id>
      <enabled>Y</enabled>
      <name>OBJECT_NAME</name>
    </field>
    <field>
      <id>OBJECT_COPY</id>
      <enabled>Y</enabled>
      <name>OBJECT_COPY</name>
    </field>
    <field>
      <id>REPOSITORY_DIRECTORY</id>
      <enabled>Y</enabled>
      <name>REPOSITORY_DIRECTORY</name>
    </field>
    <field>
      <id>FILENAME</id>
      <enabled>Y</enabled>
      <name>FILENAME</name>
    </field>
    <field>
      <id>OBJECT_ID</id>
      <enabled>Y</enabled>
      <name>OBJECT_ID</name>
    </field>
    <field>
      <id>OBJECT_REVISION</id>
      <enabled>Y</enabled>
      <name>OBJECT_REVISION</name>
    </field>
    <field>
      <id>PARENT_CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>PARENT_CHANNEL_ID</name>
    </field>
    <field>
      <id>ROOT_CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>ROOT_CHANNEL_ID</name>
    </field>
  </channel-log-table>
  <pass_batchid>N</pass_batchid>
  <shared_objects_file />
  <entries>
    <entry>
      <name>START</name>
      <description />
      <type>SPECIAL</type>
      <start>Y</start>
      <dummy>N</dummy>
      <repeat>N</repeat>
      <schedulerType>0</schedulerType>
      <intervalSeconds>0</intervalSeconds>
      <intervalMinutes>60</intervalMinutes>
      <hour>12</hour>
      <minutes>0</minutes>
      <weekDay>1</weekDay>
      <DayOfMonth>1</DayOfMonth>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>144</xloc>
      <yloc>432</yloc>
    </entry>
    <entry>
      <name>getsysdate</name>
      <description />
      <type>TRANS</type>
      <specification_method>filename</specification_method>
      <trans_object_id />
      <filename>${Internal.Entry.Current.Directory}/clean_getsysdate.ktr</filename>
      <transname />
      <arg_from_previous>N</arg_from_previous>
      <params_from_previous>N</params_from_previous>
      <exec_per_row>N</exec_per_row>
      <clear_rows>N</clear_rows>
      <clear_files>N</clear_files>
      <set_logfile>N</set_logfile>
      <logfile />
      <logext />
      <add_date>N</add_date>
      <add_time>N</add_time>
      <loglevel>Basic</loglevel>
      <cluster>N</cluster>
      <slave_server_name />
      <set_append_logfile>N</set_append_logfile>
      <wait_until_finished>Y</wait_until_finished>
      <follow_abort_remote>N</follow_abort_remote>
      <create_parent_folder>N</create_parent_folder>
      <logging_remote_work>N</logging_remote_work>
      <run_configuration>Pentaho local</run_configuration>
      <parameters>
        <pass_all_parameters>Y</pass_all_parameters>
      </parameters>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>320</xloc>
      <yloc>432</yloc>
    </entry>
    <entry>
      <name>1.用户活跃信息基础标签表</name>
      <description />
      <type>SQL</type>
      <sql>--1.用户活跃信息基础标签表

set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_dmt.HTV_SERV_BASIC partition(date_time)
select a.deviceid as deviceid,
 (case when b.deviceid is not null then 1 else 0 end) as is_boot, -- 当日是否开机
 (case when c.deviceid is not null then 1 else 0 end) as is_play, -- 当日是否播放
 (case when c.play_duration is not null then c.play_duration else 0 end) as
play_duration, -- 当日播放时长
 (case when c.play_num is not null then c.play_num else 0 end) as play_num , -- 当日播放次数
 (case when d.deviceid is not null then 1 else 0 end) as is_live, -- 当日收看直播
 (case when d.play_num is not null then d.play_num else 0 end) as live_play_num, -- 当日收看直播次数
 (case when d.play_duration is not null then d.play_duration else 0 end) as
live_play_duration, -- 当日收看直播时长
 (case when e.deviceid is not null then 1 else 0 end) as is_demand, -- 当日收看点播
 (case when e.play_num is not null then e.play_num else 0 end) as demand_play_num, --当日收看点播次数
 (case when e.play_duration is not null then e.play_duration else 0 end) as
demand_play_duration, -- 当日收看点播时长
 (case when f.deviceid is not null then 1 else 0 end) as is_replay, -- 当日收看回看
 (case when f.play_num is not null then f.play_num else 0 end) as replay_play_num, --当日收看回看次数
 (case when f.play_duration is not null then f.play_duration else 0 end) as
replay_play_duration, -- 当日收看回看时长 
'20210901' as date_time
from(
select deviceid from knowyou_ott_edw.edw_mbh_deviceinfo
where date_time='20210901')a
-- 是否开机
left join (
select distinct deviceid from knowyou_ott_edw.edw_mbh_devicestate where
date_time='20210901' and active_state='1'
)b on a.deviceid =b.deviceid
--当日是否播放\当日播放时长\当日播放次数
left join( 
select deviceid,count(*) as play_num,round(sum(playTime)/3600,1) as play_duration
from knowyou_ott_ods.ods_mbh_userbehavior_buffer
 where date_time='20210901' and playstatus='开始'
 group by deviceid
)c on a.deviceid=c.deviceid
-- 当日收看直播\次数\时长
left join(
select deviceid,count(*) as play_num,round(sum(playTime)/3600,1) as play_duration
from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='直播'
group by deviceid
)d on a.deviceid=d.deviceid 
-- 当日收看点播\次数\时长
left join(
select deviceid,count(*) as play_num,round(sum(playTime)/3600,1) as play_duration
from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='点播'
group by deviceid
)e on a.deviceid=e.deviceid
-- 当日收看回播\次数\时长
left join(
select deviceid,count(*) as play_num,round(sum(playTime)/3600,1) as play_duration
 from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='回看'
group by deviceid
)f on a.deviceid=f.deviceid</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>480</xloc>
      <yloc>432</yloc>
    </entry>
    <entry>
      <name>2.直播时段偏好标签表</name>
      <description />
      <type>SQL</type>
      <sql>-- 2.直播时段偏好标签表
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_dmt.htv_live_prefer partition(date_time)
select a.deviceid as deviceid,
 (case when b.deviceid is not null then 1 else 0 end) as live_prefer_lv1,
 (case when c.deviceid is not null then 1 else 0 end) as live_prefer_lv2,
 (case when d.deviceid is not null then 1 else 0 end) as live_prefer_lv3,
 (case when e.deviceid is not null then 1 else 0 end) as live_prefer_lv4,
 (case when f.deviceid is not null then 1 else 0 end) as live_prefer_lv5,
 (case when g.deviceid is not null then 1 else 0 end) as live_prefer_lv6,
 (case when h.deviceid is not null then 1 else 0 end) as live_prefer_lv7,
 '20210901' as date_time
from(
select deviceid from knowyou_ott_edw.edw_mbh_deviceinfo
where date_time='20210901')a
-- 当日直播时段0-6点偏好
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='直播'
and substr(actiontime,9,2)>='00' and substr(actiontime,9,2)&lt;'06'
)b on a.deviceid=b.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='直播'
and substr(actiontime,9,2)>='06' and substr(actiontime,9,2)&lt;'09'
)c on a.deviceid=c.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='直播'
and substr(actiontime,9,2)>='09' and substr(actiontime,9,2)&lt;'12'
)d on a.deviceid=d.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='直播'
and substr(actiontime,9,2)>='12' and substr(actiontime,9,2)&lt;'14'
)e on a.deviceid=e.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='直播'
and substr(actiontime,9,2)>='14' and substr(actiontime,9,2)&lt;'18'
)f on a.deviceid=f.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='直播'
and substr(actiontime,9,2)>='18' and substr(actiontime,9,2)&lt;'22'
)g on a.deviceid=g.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='直播'
and substr(actiontime,9,2)>='22' and substr(actiontime,9,2)&lt;'24'
)h on a.deviceid=h.deviceid</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>640</xloc>
      <yloc>288</yloc>
    </entry>
    <entry>
      <name>3.点播时段偏好标签表</name>
      <description />
      <type>SQL</type>
      <sql>-- 3.点播时段偏好标签表
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_dmt.htv_demand_prefer partition(date_time)
select a.key as deviceid,
 (case when b.deviceid is not null then 1 else 0 end) as demand_prefer_lv1,
 (case when c.deviceid is not null then 1 else 0 end) as demand_prefer_lv2,
 (case when d.deviceid is not null then 1 else 0 end) as demand_prefer_lv3,
 (case when e.deviceid is not null then 1 else 0 end) as demand_prefer_lv4,
 (case when f.deviceid is not null then 1 else 0 end) as demand_prefer_lv5,
 (case when g.deviceid is not null then 1 else 0 end) as demand_prefer_lv6,
 (case when h.deviceid is not null then 1 else 0 end) as demand_prefer_lv7,
 '20210901' as date_time
from(
select key from knowyou_ott_edw.edw_mbh_deviceinfo
where date_time='20210901')a
LEFT JOIN(
-- 当日点播时段0-6点偏好
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='点播'
and substr(actiontime,9,2)>='00' and substr(actiontime,9,2)&lt;'06'
)b on a.key=b.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='点播'
and substr(actiontime,9,2)>='06' and substr(actiontime,9,2)&lt;'09'
)c on a.key=c.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='点播'
and substr(actiontime,9,2)>='09' and substr(actiontime,9,2)&lt;'12'
)d on a.key=d.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='点播'
and substr(actiontime,9,2)>='12' and substr(actiontime,9,2)&lt;'14'
)e on a.key=e.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='点播'
and substr(actiontime,9,2)>='14' and substr(actiontime,9,2)&lt;'18'
)f on a.key=f.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='点播'
and substr(actiontime,9,2)>='18' and substr(actiontime,9,2)&lt;'22'
)g on a.key=g.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='点播'
and substr(actiontime,9,2)>='22' and substr(actiontime,9,2)&lt;'24'
)h on a.key=h.deviceid
</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>640</xloc>
      <yloc>400</yloc>
    </entry>
    <entry>
      <name>4.回看时段偏好标签表</name>
      <description />
      <type>SQL</type>
      <sql>-- 4.回看时段偏好标签表
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_dmt.htv_replay_prefer partition(date_time)
select  a.key as deviceid,
 (case when b.deviceid is not null then 1 else 0 end) as replay_prefer_lv1,
 (case when c.deviceid is not null then 1 else 0 end) as replay_prefer_lv2,
 (case when d.deviceid is not null then 1 else 0 end) as replay_prefer_lv3,
 (case when e.deviceid is not null then 1 else 0 end) as replay_prefer_lv4,
 (case when f.deviceid is not null then 1 else 0 end) as replay_prefer_lv5,
 (case when g.deviceid is not null then 1 else 0 end) as replay_prefer_lv6,
 (case when h.deviceid is not null then 1 else 0 end) as replay_prefer_lv7,
 '20210901' as date_time
from(
select key from knowyou_ott_edw.edw_mbh_deviceinfo
where date_time='20210901')a
-- 当日回看时段0-6点偏好
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='回看'
and substr(actiontime,9,2)>='00' and substr(actiontime,9,2)&lt;'06'
)b on a.key=b.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='回看'
and substr(actiontime,9,2)>='06' and substr(actiontime,9,2)&lt;'09'
)c on a.key=c.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='回看'
and substr(actiontime,9,2)>='09' and substr(actiontime,9,2)&lt;'12'
)d on a.key=d.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='回看'
and substr(actiontime,9,2)>='12' and substr(actiontime,9,2)&lt;'14'
)e on a.key=e.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='回看'
and substr(actiontime,9,2)>='14' and substr(actiontime,9,2)&lt;'18'
)f on a.key=f.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='回看'
and substr(actiontime,9,2)>='18' and substr(actiontime,9,2)&lt;'22'
)g on a.key=g.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer 
where date_time='20210901' and playstatus='开始' and videotype='回看'
and substr(actiontime,9,2)>='22' and substr(actiontime,9,2)&lt;'24'
)h on a.key=h.deviceid</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>640</xloc>
      <yloc>496</yloc>
    </entry>
    <entry>
      <name>当日直播频道偏好标签中间表</name>
      <description />
      <type>SQL</type>
      <sql>-- 当日直播频道偏好标签中间表
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
insert overwrite table knowyou_ott_dmt.htv_channel_dm partition(date_time)
select  a.deviceid,a.channelname,sum(a.playtime) as
play_duration,a.date_time as date_time
from(
select deviceid,
 (case when channelname in ('CCTV-1','cctv-1','ysten-cctv-1') then
'CCTV1'
 when channelname in ('CCTV-2','cctv-2') then 'CCTV2'
 when channelname in ('CCTV-3','cctv-3') then 'CCTV3'
 when channelname in ('CCTV-4','cctv-4') then 'CCTV4'
 when channelname in ('CCTV-5','cctv-5','cctv5+','ysten-cctv-5','ysten-cctv5plus','CCTV5+') then
'CCTV5'
 when channelname in ('CCTV-6','cctv-6') then 'CCTV6'
 when channelname in ('CCTV-7','cctv-7') then 'CCTV7'
 when channelname in ('CCTV-8','cctv-8') then 'CCTV8'
 when channelname in ('CCTV-9','cctv-9') then 'CCTV9'
 when channelname in ('CCTV-10','cctv-10') then 'CCTV10'
 when channelname in ('CCTV-11','cctv-11') then 'CCTV11'
 when channelname in ('CCTV-12','cctv-12') then 'CCTV12'
 when channelname in ('CCTV-13','cctv-13') then
'CCTV13'
 when channelname in ('CCTV-14','cctv-14') then 'CCTV14'
 when channelname in ('CCTV-15','cctv-15') then 'CCTV14'
 when channelname in ('CCTV-16','cctv-16') then 'CCTV14'
 when channelname in ('CCTV-17','cctv-17') then 'CCTV14'
 when channelname in ('江苏卫视','jiangsustv')then '江苏卫视'
 when channelname in ('浙江卫视','zhejiangstv')then '浙江卫视'
 when channelname in ('湖南卫视','hunanstv')then '湖南卫视'
 when channelname in ('北京卫视','beijingstv')then '北京卫视'
 when channelname in ('深圳卫视','shenzhenstv')then '深圳卫视'
 when channelname in ('辽宁卫视','liaoningstv')then '辽宁卫视'
 when channelname in ('湖北卫视','hubeistv')then '湖北卫视'
 when channelname in ('安徽卫视','anhuistv')then '安徽卫视'
 when channelname in ('重庆卫视','chongqingstv')then '重庆卫视'
 when channelname in ('天津卫视','tianjinstv')then '天津卫视'
 when channelname in ('黑龙江卫视','heilongjiangstv')then '黑龙江卫视'
 when channelname in ('吉林卫视','jilinstv')then '吉林卫视'
 when channelname in ('内蒙古卫视','neimenggustv')then '内蒙古卫视'
 when channelname in ('河北卫视','hebeistv')then '河北卫视'
 when channelname in ('河南卫视','henanstv')then '河南卫视'
 when channelname in ('江西卫视','jiangxistv')then '江西卫视'
 when channelname in ('广东卫视','guangdongstv')then '广东卫视'
 when channelname in ('广西卫视','guangxistv')then '广西卫视'
 when channelname in ('东南卫视','dongnanstv')then '东南卫视'
 when channelname in ('云南卫视','yunnanstv')then '云南卫视'
 when channelname in ('贵州卫视','guizhoustv')then '贵州卫视'
 when channelname in ('山西卫视','shanxistv')then '山西卫视'
 when channelname in ('山东卫视','shandongstv')then '山东卫视'
 when channelname in ('宁夏卫视','ningxiastv')then '宁夏卫视'
 else '其他直播频道' end) as channelname,
 playtime,date_time
from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210914' and playstatus='开始' and videotype='直播'
)a
group by a.deviceid,a.channelname,a.date_time;</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>800</xloc>
      <yloc>288</yloc>
    </entry>
    <entry>
      <name>5 当日直播CCTV频道偏好标签表</name>
      <description />
      <type>SQL</type>
      <sql>--5 当日直播CCTV频道偏好标签表
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_dmt.htv_channel_prefer_cctv_dm
partition(date_time='20210901')
select  a.key as deviceid ,
 (case when b.deviceid is not null then 1 else 0 end) as channel_prefer_cctv1,
 (case when b.deviceid is not null and b.play_duration&lt;3600 then 1 else 0 end) as
channel_low_prefer_cctv1,
 (case when b.deviceid is not null and b.play_duration>=3600 and
b.play_duration&lt;=10800 then 1 else 0 end) as channel_middle_prefer_cctv1,
 (case when b.deviceid is not null and b.play_duration>10800 and b.counts>2 then 1 else 0 end) as
channel_high_prefer_cctv1,
 (case when c.deviceid is not null then 1 else 0 end) as channel_prefer_cctv2,
 (case when c.deviceid is not null and c.play_duration&lt;3600 then 1 else 0 end) as
channel_low_prefer_cctv2,
 (case when c.deviceid is not null and c.play_duration>=3600 and
c.play_duration&lt;=10800 then 1 else 0 end) as channel_middle_prefer_cctv2,
 (case when c.deviceid is not null and c.play_duration>10800 then 1 else 0 end) as
channel_high_prefer_cctv2,
 (case when d.deviceid is not null then 1 else 0 end) as channel_prefer_cctv3,
 (case when d.deviceid is not null and d.play_duration&lt;3600 then 1 else 0 end) as
channel_low_prefer_cctv3,
 (case when d.deviceid is not null and d.play_duration>=3600 and
d.play_duration&lt;=10800 then 1 else 0 end) as channel_middle_prefer_cctv3,
 (case when d.deviceid is not null and d.play_duration>10800 then 1 else 0 end) as
channel_high_prefer_cctv3,
 (case when e.deviceid is not null then 1 else 0 end) as channel_prefer_cctv4,
 (case when e.deviceid is not null and d.play_duration&lt;3600 then 1 else 0 end) as
channel_low_prefer_cctv4,
 (case when e.deviceid is not null and d.play_duration>=3600 and
d.play_duration&lt;=10800 then 1 else 0 end) as channel_middle_prefer_cctv4,
 (case when e.deviceid is not null and d.play_duration>10800 then 1 else 0 end) as
channel_high_prefer_cctv4,
 (case when f.deviceid is not null then 1 else 0 end) as channel_prefer_cctv5,
 (case when f.deviceid is not null and f.play_duration&lt;3600 then 1 else 0 end) as
channel_low_prefer_cctv5,
 (case when f.deviceid is not null and f.play_duration>=3600 and
f.play_duration&lt;=10800 then 1 else 0 end) as channel_middle_prefer_cctv5,
 (case when f.deviceid is not null and f.play_duration>10800 then 1 else 0 end) as
channel_high_prefer_cctv5,
 (case when g.deviceid is not null then 1 else 0 end) as channel_prefer_cctv6,
 (case when g.deviceid is not null and g.play_duration&lt;3600 then 1 else 0 end) as
channel_low_prefer_cctv6,
 (case when g.deviceid is not null and g.play_duration>=3600 and
g.play_duration&lt;=10800 then 1 else 0 end) as channel_middle_prefer_cctv6,
 (case when g.deviceid is not null and g.play_duration>10800 then 1 else 0 end) as
channel_high_prefer_cctv6,
 (case when h.deviceid is not null then 1 else 0 end) as channel_prefer_cctv7,
 (case when h.deviceid is not null and h.play_duration&lt;3600 then 1 else 0 end) as
channel_low_prefer_cctv7,
 (case when h.deviceid is not null and h.play_duration>=3600 and
h.play_duration&lt;=10800 then 1 else 0 end) as channel_middle_prefer_cctv7,
 (case when h.deviceid is not null and h.play_duration>10800 then 1 else 0 end) as
channel_high_prefer_cctv7,
 (case when i.deviceid is not null then 1 else 0 end) as channel_prefer_cctv8,
 (case when i.deviceid is not null and i.play_duration&lt;3600 then 1 else 0 end) as
channel_low_prefer_cctv8,
 (case when i.deviceid is not null and i.play_duration>=3600 and
i.play_duration&lt;=10800 then 1 else 0 end) as channel_middle_prefer_cctv8,
 (case when i.deviceid is not null and i.play_duration>10800 then 1 else 0 end) as
channel_high_prefer_cctv8,
 (case when j.deviceid is not null then 1 else 0 end) as channel_prefer_cctv9,
 (case when j.deviceid is not null and j.play_duration&lt;3600 then 1 else 0 end) as
channel_low_prefer_cctv9,
 (case when j.deviceid is not null and j.play_duration>=3600 and
j.play_duration&lt;=10800 then 1 else 0 end) as channel_middle_prefer_cctv9,
 (case when j.deviceid is not null and j.play_duration>10800 then 1 else 0 end) as
channel_high_prefer_cctv9,
 (case when k.deviceid is not null then 1 else 0 end) as channel_prefer_cctv10,
 (case when k.deviceid is not null and k.play_duration&lt;3600 then 1 else 0 end) as
channel_low_prefer_cctv10,
 (case when k.deviceid is not null and k.play_duration>=3600 and
k.play_duration&lt;=10800 then 1 else 0 end) as channel_middle_prefer_cctv10,
 (case when k.deviceid is not null and k.play_duration>10800 then 1 else 0 end) as
channel_high_prefer_cctv10,
 (case when l.deviceid is not null then 1 else 0 end) as channel_prefer_cctv11,
 (case when l.deviceid is not null and l.play_duration&lt;3600 then 1 else 0 end) as
channel_low_prefer_cctv11,
 (case when l.deviceid is not null and l.play_duration>=3600 and
l.play_duration&lt;=10800 then 1 else 0 end) as channel_middle_prefer_cctv11,
 (case when l.deviceid is not null and l.play_duration>10800 then 1 else 0 end) as
channel_high_prefer_cctv11,
 (case when m.deviceid is not null then 1 else 0 end) as channel_prefer_cctv12,
 (case when m.deviceid is not null and m.play_duration&lt;3600 then 1 else 0 end) as
channel_low_prefer_cctv12,
 (case when m.deviceid is not null and m.play_duration>=3600 and
m.play_duration&lt;=10800 then 1 else 0 end) as channel_middle_prefer_cctv12,
 (case when m.deviceid is not null and m.play_duration>10800 then 1 else 0 end) as
channel_high_prefer_cctv12,
 (case when n.deviceid is not null then 1 else 0 end) as channel_prefer_cctv13,
 (case when n.deviceid is not null and n.play_duration&lt;3600 then 1 else 0 end) as
channel_low_prefer_cctv13,
 (case when n.deviceid is not null and n.play_duration>=3600 and
n.play_duration&lt;=10800 then 1 else 0 end) as channel_middle_prefer_cctv13,
 (case when n.deviceid is not null and n.play_duration>10800 then 1 else 0 end) as
channel_high_prefer_cctv13,
 (case when o.deviceid is not null then 1 else 0 end) as channel_prefer_cctv14,
 (case when o.deviceid is not null and o.play_duration&lt;3600 then 1 else 0 end) as
channel_low_prefer_cctv14,
 (case when o.deviceid is not null and o.play_duration>=3600 and
o.play_duration&lt;=10800 then 1 else 0 end) as channel_middle_prefer_cctv14,
 (case when o.deviceid is not null and o.play_duration>10800 then 1 else 0 end) as
channel_high_prefer_cctv14,
 (case when p.deviceid is not null then 1 else 0 end) as channel_prefer_cctv15,
 (case when p.deviceid is not null and p.play_duration&lt;3600 then 1 else 0 end) as
channel_low_prefer_cctv15,
 (case when p.deviceid is not null and p.play_duration>=3600 and
p.play_duration&lt;=10800 then 1 else 0 end) as channel_middle_prefer_cctv15,
 (case when p.deviceid is not null and p.play_duration>10800 then 1 else 0 end) as
channel_high_prefer_cctv15,
(case when q.deviceid is not null then 1 else 0 end) as channel_prefer_cctv16,
 (case when q.deviceid is not null and q.play_duration&lt;3600 then 1 else 0 end) as
channel_low_prefer_cctv16,
 (case when q.deviceid is not null and q.play_duration>=3600 and
o.play_duration&lt;=10800 then 1 else 0 end) as channel_middle_prefer_cctv16,
 (case when q.deviceid is not null and q.play_duration>10800 then 1 else 0 end) as
channel_high_prefer_cctv16,
(case when r.deviceid is not null then 1 else 0 end) as channel_prefer_cctv17,
 (case when r.deviceid is not null and r.play_duration&lt;3600 then 1 else 0 end) as
channel_low_prefer_cctv17,
 (case when r.deviceid is not null and r.play_duration>=3600 and
o.play_duration&lt;=10800 then 1 else 0 end) as channel_middle_prefer_cctv17,
 (case when r.deviceid is not null and r.play_duration>10800 then 1 else 0 end) as
channel_high_prefer_cctv17 
from(
select deviceid as key from knowyou_ott_edw.edw_mbh_deviceinfo
where date_time='20210901')a
left join(
select x.deviceid,x.play_duration,y.counts from knowyou_ott_dmt.htv_channel_dm x 
left join (select deviceid,count(date_time) as counts from htv_channel_dm where date_time>=20210830 and channelname='CCTV1'  group by deviceid)y on x.deviceid=y.deviceid where x.date_time='20210901' and x.channelname='CCTV1' 
)b on a.key=b.deviceid
left join(
select deviceid,play_duration from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='CCTV2'
)c on a.key=c.deviceid
left join(
select deviceid,play_duration from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='CCTV3'
)d on a.key=d.deviceid
left join(
select deviceid,play_duration from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='CCTV4'
)e on a.key=e.deviceid
left join(
select deviceid,play_duration from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='CCTV5'
)f on a.key=f.deviceid
left join(
select deviceid,play_duration from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='CCTV6'
)g on a.key=g.deviceid
left join(
select deviceid,play_duration from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='CCTV7'
)h on a.key=h.deviceid
left join(
select deviceid,play_duration from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='CCTV8'
)i on a.key=i.deviceid
left join(
select deviceid,play_duration from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='CCTV9'
)j on a.key=j.deviceid
left join(
select deviceid,play_duration from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='CCTV10'
)k on a.key=k.deviceid
left join(
select deviceid,play_duration from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='CCTV11'
)l on a.key=l.deviceid
left join(
select deviceid,play_duration from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='CCTV12'
)m on a.key=m.deviceid
left join(
select deviceid,play_duration from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='CCTV13'
)n on a.key=n.deviceid
left join(
select deviceid,play_duration from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='CCTV14'
)o on a.key=o.deviceid
left join(
select deviceid,play_duration from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='CCTV15'
)p on a.key=p.deviceid 
left join(
select deviceid,play_duration from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='CCTV16'
)q on a.key=q.deviceid 
left join(
select deviceid,play_duration from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='CCTV17'
)r on a.key=r.deviceid</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>960</xloc>
      <yloc>288</yloc>
    </entry>
    <entry>
      <name>6 当日直播卫视频道偏好标签表</name>
      <description />
      <type>SQL</type>
      <sql>--6 当日直播卫视频道偏好标签表
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_dmt.htv_channel_prefer_dm partition(date_time)
select a.key as deviceid,
 (case when b.deviceid is not null then 1 else 0 end) as channel_prefer_lv1, -- 江苏卫视 
 (case when c.deviceid is not null then 1 else 0 end) as channel_prefer_lv2,
 (case when d.deviceid is not null then 1 else 0 end) as channel_prefer_lv3,
 (case when e.deviceid is not null then 1 else 0 end) as channel_prefer_lv4,
 (case when f.deviceid is not null then 1 else 0 end) as channel_prefer_lv5,
 (case when g.deviceid is not null then 1 else 0 end) as channel_prefer_lv6,
 (case when h.deviceid is not null then 1 else 0 end) as channel_prefer_lv7,
 (case when i.deviceid is not null then 1 else 0 end) as channel_prefer_lv8,
 (case when j.deviceid is not null then 1 else 0 end) as channel_prefer_lv9,
 (case when k.deviceid is not null then 1 else 0 end) as channel_prefer_lv10,
 (case when l.deviceid is not null then 1 else 0 end) as channel_prefer_lv11,
 (case when m.deviceid is not null then 1 else 0 end) as channel_prefer_lv12,
 (case when n.deviceid is not null then 1 else 0 end) as channel_prefer_lv13,
 (case when o.deviceid is not null then 1 else 0 end) as channel_prefer_lv14,
 (case when p.deviceid is not null then 1 else 0 end) as channel_prefer_lv15,
 (case when q.deviceid is not null then 1 else 0 end) as channel_prefer_lv16,
 (case when r.deviceid is not null then 1 else 0 end) as channel_prefer_lv17,
 (case when s.deviceid is not null then 1 else 0 end) as channel_prefer_lv18,
 (case when t.deviceid is not null then 1 else 0 end) as channel_prefer_lv19,
 (case when u.deviceid is not null then 1 else 0 end) as channel_prefer_lv20,
 (case when v.deviceid is not null then 1 else 0 end) as channel_prefer_lv21,
 (case when w.deviceid is not null then 1 else 0 end) as channel_prefer_lv22,
 (case when x.deviceid is not null then 1 else 0 end) as channel_prefer_lv23,
 (case when y.deviceid is not null then 1 else 0 end) as channel_prefer_lv24,
 '20210901' as date_time
from(
select deviceid as key from knowyou_ott_edw.edw_mbh_deviceinfo
where date_time='20210901')a
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='江苏卫视'
)b on a.key=b.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='浙江卫视'
)c on a.key=c.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='湖南卫视'
)d on a.key=d.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='北京卫视'
)e on a.key=e.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='深圳卫视'
)f on a.key=f.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='辽宁卫视'
)g on a.key=g.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='湖北卫视'
)h on a.key=h.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='安徽卫视'
)i on a.key=i.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='重庆卫视'
)j on a.key=j.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='天津卫视'
)k on a.key=k.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='黑龙江卫视'
)l on a.key=l.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='吉林卫视'
)m on a.key=m.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='内蒙古卫视'
)n on a.key=n.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='河北卫视'
)o on a.key=o.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='河南卫视'
)p on a.key=p.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='江西卫视'
)q on a.key=q.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='广东卫视'
)r on a.key=r.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='广西卫视'
)s on a.key=s.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='东南卫视'
)t on a.key=t.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='云南卫视'
)u on a.key=u.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='贵州卫视'
)v on a.key=v.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='山西卫视'
)w on a.key=w.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='山东卫视'
)x on a.key=x.deviceid
left join(
select deviceid from knowyou_ott_dmt.htv_channel_dm
where date_time='20210901' and channelname='宁夏卫视'
)y on a.key=y.deviceid</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>1104</xloc>
      <yloc>288</yloc>
    </entry>
    <entry>
      <name>7.当日点播栏目偏好标签表</name>
      <description />
      <type>SQL</type>
      <sql>-- 7.当日点播栏目偏好标签表
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_dmt.htv_demand_type_prefer_dm partition(date_time)
select  a.key as deviceid,
 (case when b.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv1,
 (case when c.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv2,
 (case when d.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv3,
 (case when e.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv4,
 (case when f.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv5,
 (case when g.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv6,
 (case when h.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv7,
 (case when i.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv8,
 (case when j.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv9,
 (case when k.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv10,
 (case when l.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv11,
 (case when m.deviceid is not null then 1 else 0 end) as demand_type_prefer_other,
 '20210901' as date_time
from(
select deviceid as key from knowyou_ott_edw.edw_mbh_deviceinfo
where date_time='20210901')a
left join( 
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='电视剧' and playstatus='开始' and
videotype='点播'
)b on a.key=b.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='电影' and playstatus='开始' and
videotype='点播'
)c on a.key=c.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='动漫' and playstatus='开始' and
videotype='点播'
)d on a.key=d.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='体育' and playstatus='开始' and
videotype='点播'
)e on a.key=e.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='纪录片' and playstatus='开始' and
videotype='点播'
)f on a.key=f.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='音乐' and playstatus='开始' and
videotype='点播'
)g on a.key=g.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='新闻' and playstatus='开始' and
videotype='点播'
)h on a.key=h.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='娱乐' and playstatus='开始' and
videotype='点播'
)i on a.key=i.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='综艺' and playstatus='开始' and
videotype='点播'
)j on a.key=j.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='生活' and playstatus='开始' and
videotype='点播'
)k on a.key=k.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='少儿' and playstatus='开始' and
videotype='点播'
)l on a.key=l.deviceid 
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType!='少儿' and contentType!='生活' and contentType='综艺' and  contentType!='娱乐' and contentType!='新闻' and contentType!='音乐' and contentType!='纪录片' and contentType!='体育' and contentType!='动漫' and contentType!='电影' and  contentType!='电视剧' and playstatus='开始' and
videotype='点播'
)m on a.key=m.deviceid</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>768</xloc>
      <yloc>400</yloc>
    </entry>
    <entry>
      <name>8.行为标签 新增留存分类</name>
      <description />
      <type>SQL</type>
      <sql>-------8 行为标签 新增留存分类 
insert overwrite table knowyou_ott_dmt.htv_adduserretentionlabe_dm
partition(date_time='20210901')
select 
deviceid,
max(case when date_time ='20210831' and day_1 is not null then 1 else 0 end ) as
morrow_adduser,
max(case when date_time ='20210825' and day_7 is not null then 1 else 0 end ) as
seven_adduser,
max(case when date_time ='20210817' and day_14 is not null then 1 else 0 end ) as
fourteen_adduser,
max(case when date_time ='20210801' and day_30 is not null then 1 else 0 end ) as
thirty_adduser
from
(SELECT 
deviceid,
cast(MAX(CASE WHEN
d.date_time=date_format(date_add(from_unixtime(unix_timestamp(d.dt,'yyyyMMdd'),'yyyy-MM-dd'),1),'yyyyMMdd') THEN retention_usernum END) as int) AS day_1,
cast(MAX(CASE WHEN
d.date_time=date_format(date_add(from_unixtime(unix_timestamp(d.dt,'yyyyMMdd'),'yyyy-MM-dd'),7),'yyyyMMdd') THEN retention_usernum END) as int) AS day_7,
cast(MAX(CASE WHEN
d.date_time=date_format(date_add(from_unixtime(unix_timestamp(d.dt,'yyyyMMdd'),'yyyy-MM-dd'),14),'yyyyMMdd') THEN retention_usernum END) as int) AS day_14,
cast(MAX(CASE WHEN
d.date_time=date_format(date_add(from_unixtime(unix_timestamp(d.dt,'yyyyMMdd'),'yyyy-MM-dd'),29),'yyyyMMdd') THEN retention_usernum END) as int) AS day_30,
d.dt as date_time
FROM(
SELECT c.dt,
 c.deviceid,
c.date_time,
SUM(c.open_state) AS retention_usernum
FROM(
SELECT a.deviceid,
substr(a.createtime,1,8) as dt,
b.date_time,
b.open_state
FROM knowyou_ott_edw.edw_mbh_deviceinfo a
LEFT OUTER JOIN(
SELECT deviceid,
date_time as date_time,
'1' as open_state
FROM knowyou_ott_ods.ods_mbh_userbehavior_buffer
WHERE date_time >='20210801' AND date_time&lt;='20210901'
group by date_time,deviceid
)b ON a.deviceid=b.deviceid
WHERE substr(a.createtime,1,8) >='20210801' AND
substr(a.createtime,1,8)&lt;='20210901'
)c
GROUP BY c.dt,c.date_time,c.deviceid
)d
GROUP BY d.dt,d.deviceid)ff
group by deviceid,date_time</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>480</xloc>
      <yloc>576</yloc>
    </entry>
    <entry>
      <name>9.行为标签 活跃留存分类</name>
      <description />
      <type>SQL</type>
      <sql>--------- 9 行为标签 活跃留存分类 
insert overwrite table knowyou_ott_dmt.htv_activeretentionlabe_dm
partition(date_time='20210901')
select 
deviceid,
(case when day_1=2 then 1 else 0 end) as morrow_activer,
(case when day_7=7 then 1 else 0 end) as seven_activer,
(case when day_14=14 then 1 else 0 end) as fourteen_activer,
(case when day_30=30 then 1 else 0 end) as thirty_activer
from
(select
deviceid,
sum(case when date_time >='20210831' then 1 else 0 end ) as day_1,
sum(case when date_time >='20210825' and date_time &lt;='20210901' then 1 else 0
end ) as day_7,
sum(case when date_time >='20210817' and date_time &lt;='20210901' then 1 else 0
end ) as day_14,
sum(case when date_time >='20210801' and date_time &lt;='20210901' then 1 else 0
end ) as day_30
from
(select
date_time,
deviceid,
'1' as activer_user
from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time >'20210801'
group by date_time,deviceid)a
group by deviceid)ff</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>480</xloc>
      <yloc>672</yloc>
    </entry>
    <entry>
      <name>10.行为标签 月/活跃/新增留存分类</name>
      <description />
      <type>SQL</type>
      <sql>---------------10 行为标签 月/活跃/新增留存分类
insert overwrite table knowyou_ott_dmt.htv_activeadd_retention_mm
partition(date_time='20210901')
select 
aa.deviceid,
aa.month_activer,
(case when bb.month_adduer is null then 0 else bb.month_adduer end) as month_adduer
from
(select
a.deviceid,
(case when b.deviceid is not null then 1 else 0 end) as month_activer
from
(select
distinct deviceid
from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where substr(date_time,1,6)='202108')a
left join
(select
distinct deviceid
from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901')b
on a.deviceid = b.deviceid )aa
left join (
select
a.deviceid,
(case when b.deviceid is not null then 1 else 0 end) as month_adduer
from
(select
distinct deviceid
from knowyou_ott_edw.edw_mbh_deviceinfo
WHERE substr(createtime,1,6) >='202108')a
left join
(select
distinct deviceid 
from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901')b
on a.deviceid=b.deviceid)bb
on aa.deviceid =bb.deviceid</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>480</xloc>
      <yloc>784</yloc>
    </entry>
    <entry>
      <name>15.7日回流用户</name>
      <description />
      <type>SQL</type>
      <sql>-- 15.7日回流用户
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_dmt.htv_back_flow_lv7 partition(date_time)
select  tt.* from (
select (case when b.deviceid is null and c.deviceid is not null then a.deviceid else
null end) as deviceid,
 '20210901' as date_time -- 7日回流用户
from(
select deviceid from knowyou_ott_edw.edw_mbh_deviceinfo
where date_time='20210901'
)a -- 前两天全量用户
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time>='20210825' and date_time&lt;='20210831'
)b -- 前七天开机用户
on a.deviceid=b.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901'
)c -- 昨日开机用户
on a.deviceid=c.deviceid
)tt where tt.deviceid is not null</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>352</xloc>
      <yloc>576</yloc>
    </entry>
    <entry>
      <name>15.14日回流用户</name>
      <description />
      <type>SQL</type>
      <sql>-- 15.14日回流用户
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_dmt.htv_back_flow_lv14 partition(date_time)
select  tt.* from (
select (case when b.deviceid is null and c.deviceid is not null then a.deviceid else
null end) as deviceid,
 '20210901' as date_time -- 14日回流用户
from(
select deviceid from knowyou_ott_edw.edw_mbh_deviceinfo
where date_time='20210901'
)a -- 前两天全量用户
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time>='20210820' and date_time&lt;='20210831'
)b -- 前14天开机用户
on a.deviceid=b.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901'
)c -- 昨日开机用户
on a.deviceid=c.deviceid
)tt where tt.deviceid is not null</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>352</xloc>
      <yloc>672</yloc>
    </entry>
    <entry>
      <name>15.30日回流用户</name>
      <description />
      <type>SQL</type>
      <sql>-- 15.30日回流用户
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_ods.htv_back_flow_lv30 partition(date_time)
select  tt.* from (
select (case when b.deviceid is null and c.deviceid is not null then a.deviceid else
null end) as deviceid,
 '20210901' as date_time -- 30日回流用户
from(
select deviceid from knowyou_ott_edw.edw_mbh_deviceinfo
where date_time='20210901'
)a -- 前两天全量用户
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time>='20210801' and date_time&lt;='20210831'
)b -- 前30天开机用户
on a.deviceid=b.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901'
)c -- 昨日开机用户
on a.deviceid=c.deviceid
)tt where tt.deviceid is not null</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>352</xloc>
      <yloc>784</yloc>
    </entry>
    <entry>
      <name>沉默用户</name>
      <description />
      <type>SQL</type>
      <sql>-- 沉默用户
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_ods.htv_slience_dm partition(date_time)
select  a.deviceid,
 (case when b.deviceid is null then 1 else 0 end) as pre7_slience_user,
 (case when c.deviceid is null then 1 else 0 end) as pre14_slience_user,
 (case when d.deviceid is null then 1 else 0 end) as pre30_slience_user,
 (case when e.deviceid is null then 1 else 0 end) as pre_mon_slience_user,
 '20210901' as date_time
from(
select deviceid from knowyou_ott_edw.edw_mbh_deviceinfo
where date_time='20210901'
)a
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time>='20210825' and date_time&lt;='20210831'
)b on a.deviceid = b.deviceid 
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time>='20210817' and date_time&lt;='20210901'
)c on a.deviceid = c.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time>='20210801' and date_time&lt;='20210901'
)d on a.deviceid = d.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time>='20210701' and date_time&lt;='20210801'
)e on a.deviceid = e.deviceid</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>608</xloc>
      <yloc>576</yloc>
    </entry>
    <entry>
      <name>直播频道轻偏好</name>
      <description />
      <type>SQL</type>
      <sql>-- 直播频道轻偏好
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_ods.htv_demand_content_light partition(date_time)
select  t0.deviceid,t1.videoname, '20210901' as
date_time
from(
 select a.deviceid,a.videoname
 from(
 select deviceid,channelname as videoname,sum(playTime) as play_duration from
knowyou_ott_ods.ods_mbh_userbehavior_buffer
 where date_time='20210901' and programname !='' and playstatus='开始' and
videotype='直播' group by deviceid,programname
 )a where a.play_duration&lt;2700
)t0
left join(
 select distinct videoname from (
 select videoname,row_number() over(partition by secondlevel order by playnum desc
)ranks from knowyou_ott_dmt.dmt_ht_secondlevelvideoname_wb
 where date_time='20210901'
 )b where b.ranks&lt;=100 
)t1 on t0.videoname=t1.videoname
where t1.videoname is not null</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>480</xloc>
      <yloc>304</yloc>
    </entry>
    <entry>
      <name>点播内容100个轻偏好</name>
      <description />
      <type>SQL</type>
      <sql>-- 点播内容100个轻偏好
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_ods.htv_demand_content_light partition(date_time)
select  t0.deviceid,t1.videoname, '20210901' as
date_time
from(
 select a.deviceid,a.videoname
 from(
 select deviceid,programname as videoname,sum(playTime) as play_duration from
knowyou_ott_ods.ods_mbh_userbehavior_buffer
 where date_time='20210901' and programname !='' and playstatus='开始' and
videotype='点播' group by deviceid,programname
 )a where a.play_duration&lt;2700
)t0
left join(
 select distinct videoname from (
 select videoname,row_number() over(partition by secondlevel order by playnum desc
)ranks from knowyou_ott_dmt.dmt_ht_secondlevelvideoname_wb
 where date_time='20210901'
 )b where b.ranks&lt;=100 
)t1 on t0.videoname=t1.videoname
where t1.videoname is not null</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>480</xloc>
      <yloc>208</yloc>
    </entry>
    <entry>
      <name>点播内容100个中偏好</name>
      <description />
      <type>SQL</type>
      <sql>-- 点播内容100个中偏好
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_ods.htv_demand_content_middle partition(date_time)
select  t0.deviceid,t1.videoname, '20210901' as
date_time
from(
 select a.deviceid,a.videoname
 from(
 select deviceid,programname,sum(playTime) as play_duration from
knowyou_ott_ods.ods_mbh_userbehavior_buffer
 where date_time='20210901' and programname !='' and playstatus='开始' and
videotype='点播' group by deviceid,programname
 )a where a.play_duration>=2700 and a.play_duration&lt;=5400
)t0
left join(
 select distinct videoname from (
 select videoname,row_number() over(partition by secondlevel order by playnum desc
)ranks from knowyou_ott_dmt.dmt_ht_secondlevelvideoname_wb
 where date_time='20210901'
 )b where b.ranks&lt;=100
)t1 on t0.videoname=t1.videoname
where t1.videoname is not null</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>480</xloc>
      <yloc>112</yloc>
    </entry>
    <entry>
      <name>点播内容100个重偏好</name>
      <description />
      <type>SQL</type>
      <sql>-- 点播内容100个重偏好
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_ods.htv_demand_content_high partition(date_time)
select  t0.deviceid,t1.videoname, '20210901' as
date_time
from(
 select a.deviceid,a.videoname
 from(
 select deviceid,programname,sum(playTime) as play_duration from
knowyou_ott_ods.ods_mbh_userbehavior_buffer
 where date_time='20210901' and programname !='' and playstatus='开始' and
videotype='点播' group by deviceid,programname
 )a where a.play_duration>5400
)t0
left join(
 select distinct videoname from (
 select videoname,row_number() over(partition by secondlevel order by playnum desc
)ranks from knowyou_ott_dmt.dmt_ht_secondlevelvideoname_wb
 where date_time='20210901'
 )b where b.ranks&lt;=100
)t1 on t0.videoname=t1.videoname
where t1.videoname is not null</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>480</xloc>
      <yloc>16</yloc>
    </entry>
    <entry>
      <name>行为标签 搜索收藏分类</name>
      <description />
      <type>SQL</type>
      <sql>--------- 行为标签 搜索收藏分类
insert overwrite table knowyou_ott_ods.htv_searchcollectlabe_dm
partition(date_time='20210901')
select 
aa.tag,
aa.videoname,
aa.playnum as playnums
from(
select * from(
SELECT
't1' as tag,
programname as videoname,
count(*) as playnum 
from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where actionpath regexp('.*搜索.*') and videotype='点播' and date_time='20210901'
and programname&lt;&gt;"" 
GROUP BY programname
order by playnum desc
limit 10)ff
union all
select * from(
SELECT
't2' as tag,
programname as videoname,
count(*) as playnum 
from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where actionpath regexp('.*搜索.*') and videotype='点播' and
substr(date_time,1,6)='202109' and programname&lt;&gt;"" 
GROUP BY programname
order by playnum desc
limit 10)ff
union all
select * from(
SELECT
't3' as tag,
programname as videoname,
count(*) as playnum 
from knowyou_ott_ods.ods_mbh_userbehavior_buffer 
where actionpath regexp('.*收藏.*') and videotype='点播' and date_time='20210901'
and programname&lt;&gt;"" 
GROUP BY programname
order by playnum desc
limit 10)ff
union all
select * from(
SELECT
't4' as tag,
programname as videoname,
count(*) as playnum 
from knowyou_ott_ods.ods_mbh_userbehavior_buffer 
where actionpath regexp('.*收藏.*') and videotype='点播' and
substr(date_time,1,6)='202109' and programname&lt;&gt;"" 
GROUP BY programname
order by playnum desc
limit 10)ff)aa</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>608</xloc>
      <yloc>672</yloc>
    </entry>
    <entry>
      <name>当月活跃信息基础标签表</name>
      <description />
      <type>SQL</type>
      <sql>--当月活跃信息基础标签表

set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_dmt.HTV_SERV_BASIC partition(date_time)
select a.deviceid as deviceid,
 (case when b.deviceid is not null then 1 else 0 end) as is_boot, -- 当日是否开机
 (case when c.deviceid is not null then 1 else 0 end) as is_play, -- 当日是否播放
 (case when c.play_duration is not null then c.play_duration else 0 end) as
play_duration, -- 当日播放时长
 (case when c.play_num is not null then c.play_num else 0 end) as play_num , -- 当日播放次数
 (case when d.deviceid is not null then 1 else 0 end) as is_live, -- 当日收看直播
 (case when d.play_num is not null then d.play_num else 0 end) as live_play_num, -- 当日收看直播次数
 (case when d.play_duration is not null then d.play_duration else 0 end) as
live_play_duration, -- 当日收看直播时长
 (case when e.deviceid is not null then 1 else 0 end) as is_demand, -- 当日收看点播
 (case when e.play_num is not null then e.play_num else 0 end) as demand_play_num, --当日收看点播次数
 (case when e.play_duration is not null then e.play_duration else 0 end) as
demand_play_duration, -- 当日收看点播时长
 (case when f.deviceid is not null then 1 else 0 end) as is_replay, -- 当日收看回看
 (case when f.play_num is not null then f.play_num else 0 end) as replay_play_num, --当日收看回看次数
 (case when f.play_duration is not null then f.play_duration else 0 end) as
replay_play_duration, -- 当日收看回看时长 
'20210901' as date_time
from(
select deviceid from knowyou_ott_edw.edw_mbh_deviceinfo
where date_time='20210901')a
-- 是否开机
left join (
select distinct deviceid from knowyou_ott_edw.edw_mbh_devicestate where
date_time='20210901' and active_state='1'
)b on a.deviceid =b.deviceid
--当日是否播放\当日播放时长\当日播放次数
left join( 
select deviceid,count(*) as play_num,round(sum(playTime)/3600,1) as play_duration
from knowyou_ott_ods.ods_mbh_userbehavior_buffer
 where date_time='20210901' and playstatus='开始'
 group by deviceid
)c on a.deviceid=c.deviceid
-- 当日收看直播\次数\时长
left join(
select deviceid,count(*) as play_num,round(sum(playTime)/3600,1) as play_duration
from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='直播'
group by deviceid
)d on a.deviceid=d.deviceid 
-- 当日收看点播\次数\时长
left join(
select deviceid,count(*) as play_num,round(sum(playTime)/3600,1) as play_duration
from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='点播'
group by deviceid
)e on a.deviceid=e.deviceid
-- 当日收看回播\次数\时长
left join(
select deviceid,count(*) as play_num,round(sum(playTime)/3600,1) as play_duration
 from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and playstatus='开始' and videotype='回看'
group by deviceid
)f on a.deviceid=f.deviceid</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>912</xloc>
      <yloc>496</yloc>
    </entry>
    <entry>
      <name>当月回看时段偏好标签表</name>
      <description />
      <type>SQL</type>
      <sql>-- 当月回看时段偏好标签表
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_dmt.htv_replay_prefer_month partition(date_time)
select  a.key as deviceid,
 (case when b.deviceid is not null then 1 else 0 end) as replay_prefer_lv1,
 (case when c.deviceid is not null then 1 else 0 end) as replay_prefer_lv2,
 (case when d.deviceid is not null then 1 else 0 end) as replay_prefer_lv3,
 (case when e.deviceid is not null then 1 else 0 end) as replay_prefer_lv4,
 (case when f.deviceid is not null then 1 else 0 end) as replay_prefer_lv5,
 (case when g.deviceid is not null then 1 else 0 end) as replay_prefer_lv6,
 (case when h.deviceid is not null then 1 else 0 end) as replay_prefer_lv7,
 '20210901' as date_time
from(
select key from knowyou_ott_edw.edw_mbh_deviceinfo
where date_time&lt;='20210901' and date_time>='20210801')a
-- 当月回看时段0-6点偏好
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time&gt;='20210801' and playstatus='开始' and videotype='回看'
and substr(actiontime,9,2)>='00' and substr(actiontime,9,2)&lt;'06'
)b on a.key=b.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='回看'
and substr(actiontime,9,2)>='06' and substr(actiontime,9,2)&lt;'09'
)c on a.key=c.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='回看'
and substr(actiontime,9,2)>='09' and substr(actiontime,9,2)&lt;'12'
)d on a.key=d.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='回看'
and substr(actiontime,9,2)>='12' and substr(actiontime,9,2)&lt;'14'
)e on a.key=e.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='回看'
and substr(actiontime,9,2)>='14' and substr(actiontime,9,2)&lt;'18'
)f on a.key=f.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='回看'
and substr(actiontime,9,2)>='18' and substr(actiontime,9,2)&lt;'22'
)g on a.key=g.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer 
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='回看'
and substr(actiontime,9,2)>='22' and substr(actiontime,9,2)&lt;'24'
)h on a.key=h.deviceid</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>768</xloc>
      <yloc>496</yloc>
    </entry>
    <entry>
      <name>当月点播时段偏好标签表</name>
      <description />
      <type>SQL</type>
      <sql>--当月点播时段偏好标签表
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_dmt.htv_demand_prefer_month partition(date_time)
select a.key as deviceid,
 (case when b.deviceid is not null then 1 else 0 end) as demand_prefer_lv1,
 (case when c.deviceid is not null then 1 else 0 end) as demand_prefer_lv2,
 (case when d.deviceid is not null then 1 else 0 end) as demand_prefer_lv3,
 (case when e.deviceid is not null then 1 else 0 end) as demand_prefer_lv4,
 (case when f.deviceid is not null then 1 else 0 end) as demand_prefer_lv5,
 (case when g.deviceid is not null then 1 else 0 end) as demand_prefer_lv6,
 (case when h.deviceid is not null then 1 else 0 end) as demand_prefer_lv7,
 '20210901' as date_time
from(
select key from knowyou_ott_edw.edw_mbh_deviceinfo
where date_time&lt;='20210901' and date_time>='20210801')a
LEFT JOIN(
-- 当月点播时段0-6点偏好
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='点播'
and substr(actiontime,9,2)>='00' and substr(actiontime,9,2)&lt;'06'
)b on a.key=b.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='点播'
and substr(actiontime,9,2)>='06' and substr(actiontime,9,2)&lt;'09'
)c on a.key=c.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='点播'
and substr(actiontime,9,2)>='09' and substr(actiontime,9,2)&lt;'12'
)d on a.key=d.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='点播'
and substr(actiontime,9,2)>='12' and substr(actiontime,9,2)&lt;'14'
)e on a.key=e.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='点播'
and substr(actiontime,9,2)>='14' and substr(actiontime,9,2)&lt;'18'
)f on a.key=f.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='点播'
and substr(actiontime,9,2)>='18' and substr(actiontime,9,2)&lt;'22'
)g on a.key=g.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='点播'
and substr(actiontime,9,2)>='22' and substr(actiontime,9,2)&lt;'24'
)h on a.key=h.deviceid</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>896</xloc>
      <yloc>400</yloc>
    </entry>
    <entry>
      <name>当月直播时段偏好标签表</name>
      <description />
      <type>SQL</type>
      <sql>-- 当月直播时段偏好标签表
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_dmt.htv_live_prefer_month partition(date_time)
select a.deviceid as deviceid,
 (case when b.deviceid is not null then 1 else 0 end) as live_prefer_lv1,
 (case when c.deviceid is not null then 1 else 0 end) as live_prefer_lv2,
 (case when d.deviceid is not null then 1 else 0 end) as live_prefer_lv3,
 (case when e.deviceid is not null then 1 else 0 end) as live_prefer_lv4,
 (case when f.deviceid is not null then 1 else 0 end) as live_prefer_lv5,
 (case when g.deviceid is not null then 1 else 0 end) as live_prefer_lv6,
 (case when h.deviceid is not null then 1 else 0 end) as live_prefer_lv7,
 '20210901' as date_time
from(
select deviceid from knowyou_ott_edw.edw_mbh_deviceinfo
where date_time&lt;='20210901' and date_time>='20210801')a
-- 当月直播时段0-6点偏好
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='直播'
and substr(actiontime,9,2)>='00' and substr(actiontime,9,2)&lt;'06'
)b on a.deviceid=b.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='直播'
and substr(actiontime,9,2)>='06' and substr(actiontime,9,2)&lt;'09'
)c on a.deviceid=c.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='直播'
and substr(actiontime,9,2)>='09' and substr(actiontime,9,2)&lt;'12'
)d on a.deviceid=d.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='直播'
and substr(actiontime,9,2)>='12' and substr(actiontime,9,2)&lt;'14'
)e on a.deviceid=e.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='直播'
and substr(actiontime,9,2)>='14' and substr(actiontime,9,2)&lt;'18'
)f on a.deviceid=f.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='直播'
and substr(actiontime,9,2)>='18' and substr(actiontime,9,2)&lt;'22'
)g on a.deviceid=g.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time&lt;='20210901' and date_time>='20210801' and playstatus='开始' and videotype='直播'
and substr(actiontime,9,2)>='22' and substr(actiontime,9,2)&lt;'24'
)h on a.deviceid=h.deviceid</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>1248</xloc>
      <yloc>288</yloc>
    </entry>
    <entry>
      <name>当日点播类别偏好标签表</name>
      <description />
      <type>SQL</type>
      <sql>-- 当日点播类别偏好标签表
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_dmt.htv_demand_type_prefer_dm partition(date_time)
select  a.key as deviceid,
 (case when b.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv1,
 (case when c.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv2,
 (case when d.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv3,
 (case when e.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv4,
 (case when f.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv5,
 (case when g.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv6,
 (case when h.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv7,
 (case when i.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv8,
 (case when j.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv9,
 (case when k.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv10,
 (case when l.deviceid is not null then 1 else 0 end) as demand_type_prefer_lv11,
 '20210901' as date_time
from(
select deviceid as key from knowyou_ott_edw.edw_mbh_deviceinfo
where date_time='20210901')a
left join( 
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='电视剧' and playstatus='开始' and
videotype='点播'
)b on a.key=b.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='电影' and playstatus='开始' and
videotype='点播'
)c on a.key=c.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='综艺' and playstatus='开始' and
videotype='点播'
)d on a.key=d.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='少儿' and playstatus='开始' and
videotype='点播'
)e on a.key=e.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='网剧' and playstatus='开始' and
videotype='点播'
)f on a.key=f.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='微电影' and playstatus='开始' and
videotype='点播'
)g on a.key=g.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='短视频' and playstatus='开始' and
videotype='点播'
)h on a.key=h.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='动漫' and playstatus='开始' and
videotype='点播'
)i on a.key=i.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='体育' and playstatus='开始' and
videotype='点播'
)j on a.key=j.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='纪录片' and playstatus='开始' and
videotype='点播'
)k on a.key=k.deviceid
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='教育' and playstatus='开始' and
videotype='点播'
)l on a.key=l.deviceid 
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='电竞' and playstatus='开始' and
videotype='点播'
)m on a.key=m.deviceid 
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='游戏' and playstatus='开始' and
videotype='点播'
)n on a.key=n.deviceid 
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='音乐' and playstatus='开始' and
videotype='点播'
)o on a.key=o.deviceid 
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='娱乐' and playstatus='开始' and
videotype='点播'
)p on a.key=p.deviceid 
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='戏曲' and playstatus='开始' and
videotype='点播'
)q on a.key=q.deviceid 
left join(
select distinct deviceid from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time='20210901' and contentType='生活' and playstatus='开始' and
videotype='点播'
)r on a.key=r.deviceid </sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>1008</xloc>
      <yloc>400</yloc>
    </entry>
    <entry>
      <name>直播内容轻偏好</name>
      <description />
      <type>SQL</type>
      <sql>-- 直播内容轻偏好
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_ods.htv_live_content_light partition(date_time)
select  t0.deviceid,t1.videoname, '20210901' as
date_time
from(
 select a.deviceid,a.videoname
 from(
 select deviceid,channelname as videoname,sum(playTime) as play_duration from
knowyou_ott_ods.ods_mbh_userbehavior_buffer
 where date_time='20210901' and programname !='' and playstatus='开始' and
videotype='直播' group by deviceid,programname
 )a where a.play_duration&lt;2700
)t0
left join(
 select distinct videoname from (
 select videoname,row_number() over(partition by secondlevel order by playnum desc
)ranks from knowyou_ott_dmt.dmt_ht_secondlevelvideoname_wb
 where date_time='20210901'
 )b where b.ranks&lt;=100 
)t1 on t0.videoname=t1.videoname
where t1.videoname is not null</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>320</xloc>
      <yloc>304</yloc>
    </entry>
    <entry>
      <name>直播内容100个中偏好</name>
      <description />
      <type>SQL</type>
      <sql>-- 直播内容100个中偏好
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_ods.htv_live_content_middle partition(date_time)
select  t0.deviceid,t1.videoname, '20210901' as
date_time
from(
 select a.deviceid,a.videoname
 from(
 select deviceid,programname,sum(playTime) as play_duration from
knowyou_ott_ods.ods_mbh_userbehavior_buffer
 where date_time='20210901' and programname !='' and playstatus='开始' and
videotype='直播' group by deviceid,programname
 )a where a.play_duration>=2700 and a.play_duration&lt;=5400
)t0
left join(
 select distinct videoname from (
 select videoname,row_number() over(partition by secondlevel order by playnum desc
)ranks from knowyou_ott_dmt.dmt_ht_secondlevelvideoname_wb
 where date_time='20210901'
 )b where b.ranks&lt;=100
)t1 on t0.videoname=t1.videoname
where t1.videoname is not null</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>320</xloc>
      <yloc>208</yloc>
    </entry>
    <entry>
      <name>直播内容100个重偏好</name>
      <description />
      <type>SQL</type>
      <sql>-- 直播内容100个重偏好
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite TABLE knowyou_ott_ods.htv_live_content_high partition(date_time)
select  t0.deviceid,t1.videoname, '20210901' as
date_time
from(
 select a.deviceid,a.videoname
 from(
 select deviceid,programname,sum(playTime) as play_duration from
knowyou_ott_ods.ods_mbh_userbehavior_buffer
 where date_time='20210901' and programname !='' and playstatus='开始' and
videotype='直播' group by deviceid,programname
 )a where a.play_duration>5400
)t0
left join(
 select distinct videoname from (
 select videoname,row_number() over(partition by secondlevel order by playnum desc
)ranks from knowyou_ott_dmt.dmt_ht_secondlevelvideoname_wb
 where date_time='20210901'
 )b where b.ranks&lt;=100
)t1 on t0.videoname=t1.videoname
where t1.videoname is not null</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>320</xloc>
      <yloc>112</yloc>
    </entry>
    <entry>
      <name>用户画像 分时段内容偏好标签</name>
      <description />
      <type>SQL</type>
      <sql>-- 用户画像 分时段标签


select	
deviceid,
contenttype,
hourtype,
ranks,
'20210901' as date_time
-- 分区时间
from(
select b.deviceid,b.contenttype,b.hourtype,row_number() over(partition by b.deviceid,b.hourtype order by b.play_num desc) as ranks
from(
select a.deviceid,a.contenttype,a.hourtype,count(*) as play_num
from(
select deviceid,contenttype,
(case when substr(actiontime,9,2) >='00' and substr(actiontime,9,2)&lt;'06'  then 1
when substr(actiontime,9,2) >='06' and substr(actiontime,9,2)&lt;'11' then 2
when substr(actiontime,9,2) >='11' and substr(actiontime,9,2)&lt;'16' then 3
when substr(actiontime,9,2) >='16' and substr(actiontime,9,2)&lt;='23' then 4
else 1 end)  as hourtype -- 小时段分类 
from knowyou_ott_ods.ods_mbh_userbehavior_buffer 
where date_time>'20210831' and date_time &lt;='20210901'  --近一个月
and contenttype in ('少儿','综艺','电影','电视剧','动漫','电竞','生活','纪实','音乐','体育','教育','爱家教育','新闻','云游戏','游戏') -- 可以设置类别固定内容类型
union
select deviceid,contenttype,
(case when substr(actiontime,9,2) >='00' and substr(actiontime,9,2)&lt;'06'  then 1
when substr(actiontime,9,2) >='06' and substr(actiontime,9,2)&lt;'11' then 2
when substr(actiontime,9,2) >='11' and substr(actiontime,9,2)&lt;'16' then 3
when substr(actiontime,9,2) >='16' and substr(actiontime,9,2)&lt;='23' then 4
else 1 end)  as hourtype -- 小时段分类 
from knowyou_ott_ods.ods_mbh_userbehavior_buffer 
where date_time>'20210831' and date_time &lt;='20210901'  --近一个月
and contenttype in ('少儿','综艺','电影','电视剧','动漫','电竞','生活','纪实','音乐','体育','教育','爱家教育','新闻','云游戏','游戏') -- 可以设置类别固定内容类型
)a 
group by a.deviceid,a.contenttype,a.hourtype
)b
)c where c.ranks&lt;=3</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>160</xloc>
      <yloc>304</yloc>
    </entry>
    <entry>
      <name>当日收看各类APP信息情况表</name>
      <description />
      <type>SQL</type>
      <sql>-- 当日收看各类APP信息情况表
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
insert overwrite table knowyou_ott_dmt.htv_app_basic partition(date_time)
select a.deviceid,
(case when b.deviceid is not null then 1 else 0 end) as jiguang_pre,
(case when c.deviceid is not null then c.play_num else 0 end) as jiguang_count,
(case when c.deviceid is not null then c.play_duration else 0 end) as jiguang_time,
(case when d.deviceid is not null then 1 else 0 end) as qiyi_pre,
(case when e.deviceid is not null then e.play_num else 0 end) as qiyi_count,
(case when e.deviceid is not null then e.play_duration else 0 end) as qiyi_time,
(case when f.deviceid is not null then 1 else 0 end) as bailin_pre,
(case when g.deviceid is not null then g.play_num else 0 end) as bailin_count,
(case when g.deviceid is not null then g.play_duration else 0 end) as bailin_time,
'' as date_time 
from  (
select deviceid from knowyou_ott_edw.edw_mbh_deviceinfo
where date_time='20210901')a
left join 
(select deviceid,appname from knowyou_ott_ods.ods_mbh_userbehavior_buffer 
where date_time=20210901 and appname='tv.huan.tencentTV'
)b on a.deviceid=b.deviceid  
left join 
(select deviceid,count(*) as play_num,round(sum(playTime)/3600,1) as play_duration
from knowyou_ott_ods.ods_mbh_userbehavior_buffer
 where date_time='20210901' and appname='tv.huan.tencentTV'
 group by deviceid 
)c on a.deviceid=c.deviceid 
left join 
(select deviceid,appname from knowyou_ott_ods.ods_mbh_userbehavior_buffer 
where date_time=20210901 and appname='com.gitvvideo.sichuanyidong' 
)d on a.deviceid=d.deviceid  
left join 
(select deviceid,count(*) as play_num,round(sum(playTime)/3600,1) as play_duration
from knowyou_ott_ods.ods_mbh_userbehavior_buffer
 where date_time='20210901' and appname='com.gitvvideo.sichuanyidong' 
 group by deviceid 
)e on a.deviceid=e.deviceid 
left join 
(select deviceid,appname from knowyou_ott_ods.ods_mbh_userbehavior_buffer 
where date_time=20210901 and appname='tv.icntv.ott' 
)f on a.deviceid=f.deviceid  
left join 
(select deviceid,count(*) as play_num,round(sum(playTime)/3600,1) as play_duration
from knowyou_ott_ods.ods_mbh_userbehavior_buffer
 where date_time='20210901' and appname='tv.icntv.ott' 
 group by deviceid 
)g on a.deviceid=g.deviceid ;</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>640</xloc>
      <yloc>192</yloc>
    </entry>
    <entry>
      <name>用户画像 分时段epg栏目top偏好</name>
      <description />
      <type>SQL</type>
      <sql>-- 用户画像 分时段epg栏目top偏好
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
insert overwrite table knowyou_ott_dmt.htv_epg_prefer_dm partition(date_time)
select
deviceid,
t1.fivelevel as fivelevel,
hourtype,
ranks,
'20210901' as date_time --分区时间
from
(select	
deviceid,
fivelevel,
hourtype,
ranks
from(
select b.deviceid,b.fivelevel,b.hourtype,row_number() over(partition by b.deviceid,b.hourtype order by b.play_num desc) as ranks
from(
select a.deviceid,a.fivelevel,a.hourtype,count(*) as play_num
from(
select deviceid,contenttype as fivelevel,
(case when substr(actiontime,9,2) >='00' and substr(actiontime,9,2)&lt;'06'  then 1
when substr(actiontime,9,2) >='06' and substr(actiontime,9,2)&lt;'11' then 2
when substr(actiontime,9,2) >='11' and substr(actiontime,9,2)&lt;'16' then 3
when substr(actiontime,9,2) >='16' and substr(actiontime,9,2)&lt;='23' then 4
else 1 end)  as hourtype -- 小时段分类 
from knowyou_ott_ods.ods_mbh_userbehavior_buffer
where date_time>'20210831' and date_time &lt;'20210902'  --近一个月
and contenttype !='$' and contenttype!=''
union all 
select deviceid,listsubtype as fivelevel,
(case when substr(actiontime,9,2) >='00' and substr(actiontime,9,2)&lt;'06'  then 1
when substr(actiontime,9,2) >='06' and substr(actiontime,9,2)&lt;'11' then 2
when substr(actiontime,9,2) >='11' and substr(actiontime,9,2)&lt;'16' then 3
when substr(actiontime,9,2) >='16' and substr(actiontime,9,2)&lt;='23' then 4
else 1 end)  as hourtype 
from knowyou_ott_ods.ods_mbh_userbehavior_buffer 
where date_time>'20210831' and date_time &lt;'20210902' and listsubtype!='' and listsubtype is not null 
)a 
group by a.deviceid,a.fivelevel,a.hourtype
)b
)c where c.ranks&lt;=5
)t1</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>160</xloc>
      <yloc>224</yloc>
    </entry>
    <entry>
      <name>用户特征</name>
      <description />
      <type>SQL</type>
      <sql>-- 用户特征
insert overwrite table knowyou_ott_dmt.htv_user_feature_dm partition(date_time)

select coalesce(t1.deviceid,t2.deviceid,'') as deviceid,
t1.top1_content,t1.top2_content,t1.top3_content,t2.top1_epg,
t2.top2_epg,t2.top3_epg,t2.top4_epg,t2.top5_epg,
'1' as hourtype,
coalesce(t1.date_time,t2.date_time,'') as date_time
from(
select	a.deviceid,
coalesce(a.contenttype,'') as top1_content,
coalesce(b.contenttype,'') as top2_content,
coalesce(c.contenttype,'') as top3_content,
a.date_time
from(
select deviceid,contenttype,date_time from knowyou_ott_dmt.htv_content_prefer_dm 
where date_time = '20210901'  and hourtype='1' and ranks='1'
)a
left join(
select deviceid,contenttype,date_time from knowyou_ott_dmt.htv_content_prefer_dm 
where date_time = '20210901'  and hourtype='1' and ranks='2'
)b on a.deviceid=b.deviceid
left join(
select deviceid,contenttype,date_time from knowyou_ott_dmt.htv_content_prefer_dm 
where date_time = '20210901'  and hourtype='1' and ranks='3'
)c on a.deviceid=c.deviceid
)t1
full join(
select	a.deviceid,
coalesce(a.fivelevel,'') as top1_epg,
coalesce(b.fivelevel,'') as top2_epg,
coalesce(c.fivelevel,'') as top3_epg,
coalesce(d.fivelevel,'') as top4_epg,
coalesce(e.fivelevel,'') as top5_epg,
a.date_time
from(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='1' and ranks='1'
)a
left join(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='1' and ranks='2'
)b on a.deviceid=b.deviceid
left join(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='1' and ranks='3'
)c on a.deviceid=c.deviceid
left join(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='1' and ranks='4'
)d on a.deviceid=d.deviceid
left join(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='1' and ranks='5'
)e on a.deviceid=e.deviceid
)t2 
on t1.deviceid=t2.deviceid

union all

select coalesce(t1.deviceid,t2.deviceid,'') as deviceid,
t1.top1_content,t1.top2_content,t1.top3_content,t2.top1_epg,
t2.top2_epg,t2.top3_epg,t2.top4_epg,t2.top5_epg,
'2' as hourtype,
coalesce(t1.date_time,t2.date_time,'') as date_time
from(
select	a.deviceid,
coalesce(a.contenttype,'') as top1_content,
coalesce(b.contenttype,'') as top2_content,
coalesce(c.contenttype,'') as top3_content,
a.date_time
from(
select deviceid,contenttype,date_time from knowyou_ott_dmt.htv_content_prefer_dm 
where date_time = '20210901'  and hourtype='2' and ranks='1'
)a
left join(
select deviceid,contenttype,date_time from knowyou_ott_dmt.htv_content_prefer_dm 
where date_time = '20210901'  and hourtype='2' and ranks='2'
)b on a.deviceid=b.deviceid
left join(
select deviceid,contenttype,date_time from knowyou_ott_dmt.htv_content_prefer_dm 
where date_time = '20210901'  and hourtype='2' and ranks='3'
)c on a.deviceid=c.deviceid
)t1
full join(
select	a.deviceid,
coalesce(a.fivelevel,'') as top1_epg,
coalesce(b.fivelevel,'') as top2_epg,
coalesce(c.fivelevel,'') as top3_epg,
coalesce(d.fivelevel,'') as top4_epg,
coalesce(e.fivelevel,'') as top5_epg,
a.date_time
from(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='2' and ranks='1'
)a
left join(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='2' and ranks='2'
)b on a.deviceid=b.deviceid
left join(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='2' and ranks='3'
)c on a.deviceid=c.deviceid
left join(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='2' and ranks='4'
)d on a.deviceid=d.deviceid
left join(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='2' and ranks='5'
)e on a.deviceid=e.deviceid
)t2 
on t1.deviceid=t2.deviceid

union all 

select coalesce(t1.deviceid,t2.deviceid,'') as deviceid,
t1.top1_content,t1.top2_content,t1.top3_content,t2.top1_epg,
t2.top2_epg,t2.top3_epg,t2.top4_epg,t2.top5_epg,
'3' as hourtype,
coalesce(t1.date_time,t2.date_time,'') as date_time
from(
select	a.deviceid,
coalesce(a.contenttype,'') as top1_content,
coalesce(b.contenttype,'') as top2_content,
coalesce(c.contenttype,'') as top3_content,
a.date_time
from(
select deviceid,contenttype,date_time from knowyou_ott_dmt.htv_content_prefer_dm 
where date_time = '20210901'  and hourtype='3' and ranks='1'
)a
left join(
select deviceid,contenttype,date_time from knowyou_ott_dmt.htv_content_prefer_dm 
where date_time = '20210901'  and hourtype='3' and ranks='2'
)b on a.deviceid=b.deviceid
left join(
select deviceid,contenttype,date_time from knowyou_ott_dmt.htv_content_prefer_dm 
where date_time = '20210901'  and hourtype='3' and ranks='3'
)c on a.deviceid=c.deviceid
)t1
full join(
select	a.deviceid,
coalesce(a.fivelevel,'') as top1_epg,
coalesce(b.fivelevel,'') as top2_epg,
coalesce(c.fivelevel,'') as top3_epg,
coalesce(d.fivelevel,'') as top4_epg,
coalesce(e.fivelevel,'') as top5_epg,
a.date_time
from(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='3' and ranks='1'
)a
left join(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='3' and ranks='2'
)b on a.deviceid=b.deviceid
left join(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='3' and ranks='3'
)c on a.deviceid=c.deviceid
left join(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='3' and ranks='4'
)d on a.deviceid=d.deviceid
left join(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='3' and ranks='5'
)e on a.deviceid=e.deviceid
)t2 
on t1.deviceid=t2.deviceid

union all 

select coalesce(t1.deviceid,t2.deviceid,'') as deviceid,
t1.top1_content,t1.top2_content,t1.top3_content,t2.top1_epg,
t2.top2_epg,t2.top3_epg,t2.top4_epg,t2.top5_epg,
'4' as hourtype,
coalesce(t1.date_time,t2.date_time,'') as date_time
from(
select	a.deviceid,
coalesce(a.contenttype,'') as top1_content,
coalesce(b.contenttype,'') as top2_content,
coalesce(c.contenttype,'') as top3_content,
a.date_time
from(
select deviceid,contenttype,date_time from knowyou_ott_dmt.htv_content_prefer_dm 
where date_time = '20210901'  and hourtype='4' and ranks='1'
)a
left join(
select deviceid,contenttype,date_time from knowyou_ott_dmt.htv_content_prefer_dm 
where date_time = '20210901'  and hourtype='4' and ranks='2'
)b on a.deviceid=b.deviceid
left join(
select deviceid,contenttype,date_time from knowyou_ott_dmt.htv_content_prefer_dm 
where date_time = '20210901'  and hourtype='4' and ranks='3'
)c on a.deviceid=c.deviceid
)t1
full join(
select	a.deviceid,
coalesce(a.fivelevel,'') as top1_epg,
coalesce(b.fivelevel,'') as top2_epg,
coalesce(c.fivelevel,'') as top3_epg,
coalesce(d.fivelevel,'') as top4_epg,
coalesce(e.fivelevel,'') as top5_epg,
a.date_time
from(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='4' and ranks='1'
)a
left join(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='4' and ranks='2'
)b on a.deviceid=b.deviceid
left join(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='4' and ranks='3'
)c on a.deviceid=c.deviceid
left join(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='4' and ranks='4'
)d on a.deviceid=d.deviceid
left join(
select deviceid,fivelevel,date_time from knowyou_ott_dmt.htv_epg_prefer_dm 
where date_time = '20210901'  and hourtype='4' and ranks='5'
)e on a.deviceid=e.deviceid
)t2 
on t1.deviceid=t2.deviceid </sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>160</xloc>
      <yloc>160</yloc>
    </entry>
    <entry>
      <name>用户分时段评分明细表</name>
      <description />
      <type>SQL</type>
      <sql>-- 用户分时段评分明细表
insert overwrite table knowyou_ott_dmt.htv_user_rating_detail_dm partition(date_time)

select  a.deviceid,
a.hourtype,
coalesce(m1.child_rate ,'0') as child_top1_content_rate,
coalesce(m1.teen_rate ,'0') as teen_top1_content_rate,
coalesce(m1.youth_rate ,'0') as youth_top1_content_rate,
coalesce(m1.mid_rate ,'0') as mid_top1_content_rate,
coalesce(m1.old_rate ,'0') as old_top1_content_rate,
coalesce(m1.male_rate ,'0') as male_top1_content_rate,
coalesce(m1.female_rate ,'0') as female_top1_content_rate,

coalesce(0.8*m2.child_rate ,'0') as child_top2_content_rate,
coalesce(0.8*m2.teen_rate ,'0') as teen_top2_content_rate,
coalesce(0.8*m2.youth_rate ,'0') as youth_top2_content_rate,
coalesce(0.8*m2.mid_rate ,'0') as mid_top2_content_rate,
coalesce(0.8*m2.old_rate ,'0') as old_top2_content_rate,
coalesce(0.8*m2.male_rate ,'0') as male_top2_content_rate,
coalesce(0.8*m2.female_rate ,'0') as female_top2_content_rate,

coalesce(0.6*m3.child_rate ,'0') as child_top3_content_rate,
coalesce(0.6*m3.teen_rate ,'0') as teen_top3_content_rate,
coalesce(0.6*m3.youth_rate ,'0') as youth_top3_content_rate,
coalesce(0.6*m3.mid_rate ,'0') as mid_top3_content_rate,
coalesce(0.6*m3.old_rate ,'0') as old_top3_content_rate,
coalesce(0.6*m3.male_rate ,'0') as male_top3_content_rate,
coalesce(0.6*m3.female_rate ,'0') as female_top3_content_rate,

coalesce(t1.child_rate ,'0') as child_top1_epg_rate,
coalesce(t1.teen_rate ,'0') as teen_top1_epg_rate,
coalesce(t1.youth_rate ,'0') as youth_top1_epg_rate,
coalesce(t1.mid_rate ,'0') as mid_top1_epg_rate,
coalesce(t1.old_rate ,'0') as old_top1_epg_rate,
coalesce(t1.male_rate ,'0') as male_top1_epg_rate,
coalesce(t1.female_rate ,'0') as female_top1_epg_rate,

coalesce(0.8*t2.child_rate ,'0') as child_top2_epg_rate,
coalesce(0.8*t2.teen_rate ,'0') as teen_top2_epg_rate,
coalesce(0.8*t2.youth_rate ,'0') as youth_top2_epg_rate,
coalesce(0.8*t2.mid_rate ,'0') as mid_top2_epg_rate,
coalesce(0.8*t2.old_rate ,'0') as old_top2_epg_rate,
coalesce(0.8*t2.male_rate ,'0') as male_top2_epg_rate,
coalesce(0.8*t2.female_rate ,'0') as female_top2_epg_rate,

coalesce(0.6*t3.child_rate ,'0') as child_top3_epg_rate,
coalesce(0.6*t3.teen_rate ,'0') as teen_top3_epg_rate,
coalesce(0.6*t3.youth_rate ,'0') as youth_top3_epg_rate,
coalesce(0.6*t3.mid_rate ,'0') as mid_top3_epg_rate,
coalesce(0.6*t3.old_rate ,'0') as old_top3_epg_rate,
coalesce(0.6*t3.male_rate ,'0') as male_top3_epg_rate,
coalesce(0.6*t3.female_rate ,'0') as female_top3_epg_rate,

coalesce(0.4*t4.child_rate ,'0') as child_top4_epg_rate,
coalesce(0.4*t4.teen_rate ,'0') as teen_top4_epg_rate,
coalesce(0.4*t4.youth_rate ,'0') as youth_top4_epg_rate,
coalesce(0.4*t4.mid_rate ,'0') as mid_top4_epg_rate,
coalesce(0.4*t4.old_rate ,'0') as old_top4_epg_rate,
coalesce(0.4*t4.male_rate ,'0') as male_top4_epg_rate,
coalesce(0.4*t4.female_rate ,'0') as female_top4_epg_rate,

coalesce(0.2*t5.child_rate ,'0') as child_top5_epg_rate,
coalesce(0.2*t5.teen_rate ,'0') as teen_top5_epg_rate,
coalesce(0.2*t5.youth_rate ,'0') as youth_top5_epg_rate,
coalesce(0.2*t5.mid_rate ,'0') as mid_top5_epg_rate,
coalesce(0.2*t5.old_rate ,'0') as old_top5_epg_rate,
coalesce(0.2*t5.male_rate ,'0') as male_top5_epg_rate,
coalesce(0.2*t5.female_rate ,'0') as female_top5_epg_rate,
'20210901' as date_time
from(
select * from knowyou_ott_dmt.htv_user_feature_dm
where date_time = '20210901' 
)a
left join (
select * from knowyou_ott_dmt.imp_contenttype_grade
)m1 
on a.top1_content=m1.content_type
left join (
select * from knowyou_ott_dmt.imp_contenttype_grade
)m2 
on a.top2_content=m2.content_type
left join (
select * from knowyou_ott_dmt.imp_contenttype_grade
)m3 
on a.top3_content=m3.content_type
left join (
select * from knowyou_ott_dmt.imp_epg_type_grade
)t1 
on a.top1_epg=t1.epg
left join (
select * from knowyou_ott_dmt.imp_epg_type_grade
)t2 
on a.top2_epg=t2.epg
left join (
select * from knowyou_ott_dmt.imp_epg_type_grade
)t3 
on a.top3_epg=t3.epg
left join (
select * from knowyou_ott_dmt.imp_epg_type_grade
)t4 
on a.top4_epg=t4.epg
left join (
select * from knowyou_ott_dmt.imp_epg_type_grade
)t5 
on a.top5_epg=t5.epg </sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>160</xloc>
      <yloc>96</yloc>
    </entry>
    <entry>
      <name>用户分时段总评分表</name>
      <description />
      <type>SQL</type>
      <sql>-- 用户分时段总评分表
insert overwrite table knowyou_ott_dmt.htv_user_rating_dm partition(date_time)

select  deviceid,
hourtype,
(child_top1_content_rate + child_top2_content_rate + child_top3_content_rate +child_top1_epg_rate 
+child_top2_epg_rate +child_top3_epg_rate +child_top4_epg_rate+child_top5_epg_rate) as rate,	
'child' as grouptype,
date_time
from knowyou_ott_dmt.htv_user_rating_detail_dm where date_time='20210901'
union all 
select  deviceid,
hourtype,
(teen_top1_content_rate + teen_top2_content_rate + teen_top3_content_rate +teen_top1_epg_rate 
+teen_top2_epg_rate +teen_top3_epg_rate +teen_top4_epg_rate+teen_top5_epg_rate) as rate,
'teen' as grouptype,
date_time
from knowyou_ott_dmt.htv_user_rating_detail_dm where date_time='20210901'
union all
select  deviceid,
hourtype,
(youth_top1_content_rate + youth_top2_content_rate + youth_top3_content_rate +youth_top1_epg_rate 
+youth_top2_epg_rate +youth_top3_epg_rate +youth_top4_epg_rate+youth_top5_epg_rate) as rate,
'youth' as grouptype,
date_time
from knowyou_ott_dmt.htv_user_rating_detail_dm where date_time='20210901'
union all
select  deviceid,
hourtype,
(mid_top1_content_rate + mid_top2_content_rate + mid_top3_content_rate +mid_top1_epg_rate 
+mid_top2_epg_rate +mid_top3_epg_rate +mid_top4_epg_rate+mid_top5_epg_rate) as rate,
'mid' as grouptype,
date_time
from knowyou_ott_dmt.htv_user_rating_detail_dm where date_time='20210901'
union all
select  deviceid,
hourtype,
(old_top1_content_rate + old_top2_content_rate + old_top3_content_rate +old_top1_epg_rate 
+old_top2_epg_rate +old_top3_epg_rate +old_top4_epg_rate+old_top5_epg_rate) as rate,
'old' as grouptype,
date_time
from knowyou_ott_dmt.htv_user_rating_detail_dm where date_time='20210901'
union all
select  deviceid,
hourtype,
(male_top1_content_rate + male_top2_content_rate + male_top3_content_rate +male_top1_epg_rate 
+male_top2_epg_rate +male_top3_epg_rate +male_top4_epg_rate+male_top5_epg_rate) as rate,
'male' as grouptype,
date_time
from knowyou_ott_dmt.htv_user_rating_detail_dm where date_time='20210901'
union all
select  deviceid,
hourtype,
(female_top1_content_rate + female_top2_content_rate + female_top3_content_rate +female_top1_epg_rate 
+female_top2_epg_rate +female_top3_epg_rate +female_top4_epg_rate+female_top5_epg_rate) as rate,	
'female' as grouptype,
date_time
from knowyou_ott_dmt.htv_user_rating_detail_dm where date_time='20210901' </sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>160</xloc>
      <yloc>32</yloc>
    </entry>
    <entry>
      <name>用户画像</name>
      <description />
      <type>SQL</type>
      <sql>--用户画像
insert overwrite table knowyou_ott_dmt.dm_htv_user_personas_dm partition(date_time)
select  m1.deviceid,
m1.hourtype,
m1.grouptype as grouptype ,
m2.grouptype as sex_type,
'20210901' as date_time
from(
select t1.deviceid,t1.hourtype,t1.grouptype
from(
select  deviceid,
hourtype,
grouptype,
row_number() over(partition by deviceid,hourtype order by rate desc) as ranks
from knowyou_ott_dmt.htv_user_rating_dm
where date_time='20210901' and grouptype in ('child','teen','youth','mid','old')
)t1 
where t1.ranks=1
)m1
left join (
select t2.deviceid,t2.hourtype,t2.grouptype
from(
select  deviceid,
hourtype,
grouptype,
row_number() over(partition by deviceid,hourtype order by rate desc) as ranks
from knowyou_ott_dmt.htv_user_rating_dm
where date_time='20210901' and grouptype in ('male','female')
)t2 
where t2.ranks=1
)m2 on m1.deviceid=m2.deviceid and m1.hourtype=m2.hourtype</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename />
      <sendOneStatement>F</sendOneStatement>
      <connection />
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>320</xloc>
      <yloc>32</yloc>
    </entry>
  </entries>
  <hops>
    <hop>
      <from>START</from>
      <to>getsysdate</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>Y</unconditional>
    </hop>
    <hop>
      <from>getsysdate</from>
      <to>1.用户活跃信息基础标签表</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>1.用户活跃信息基础标签表</from>
      <to>2.直播时段偏好标签表</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>2.直播时段偏好标签表</from>
      <to>当日直播频道偏好标签中间表</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>当日直播频道偏好标签中间表</from>
      <to>5 当日直播CCTV频道偏好标签表</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>1.用户活跃信息基础标签表</from>
      <to>3.点播时段偏好标签表</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>1.用户活跃信息基础标签表</from>
      <to>4.回看时段偏好标签表</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>5 当日直播CCTV频道偏好标签表</from>
      <to>6 当日直播卫视频道偏好标签表</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>3.点播时段偏好标签表</from>
      <to>7.当日点播栏目偏好标签表</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>1.用户活跃信息基础标签表</from>
      <to>8.行为标签 新增留存分类</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>8.行为标签 新增留存分类</from>
      <to>9.行为标签 活跃留存分类</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>9.行为标签 活跃留存分类</from>
      <to>10.行为标签 月/活跃/新增留存分类</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>1.用户活跃信息基础标签表</from>
      <to>15.7日回流用户</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>15.7日回流用户</from>
      <to>15.14日回流用户</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>15.14日回流用户</from>
      <to>15.30日回流用户</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>1.用户活跃信息基础标签表</from>
      <to>沉默用户</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>1.用户活跃信息基础标签表</from>
      <to>直播频道轻偏好</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>直播频道轻偏好</from>
      <to>点播内容100个轻偏好</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>点播内容100个轻偏好</from>
      <to>点播内容100个中偏好</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>点播内容100个中偏好</from>
      <to>点播内容100个重偏好</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>沉默用户</from>
      <to>行为标签 搜索收藏分类</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>4.回看时段偏好标签表</from>
      <to>当月回看时段偏好标签表</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>7.当日点播栏目偏好标签表</from>
      <to>当月点播时段偏好标签表</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>6 当日直播卫视频道偏好标签表</from>
      <to>当月直播时段偏好标签表</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>当月回看时段偏好标签表</from>
      <to>当月活跃信息基础标签表</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>当月点播时段偏好标签表</from>
      <to>当日点播类别偏好标签表</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>1.用户活跃信息基础标签表</from>
      <to>直播内容轻偏好</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>直播内容轻偏好</from>
      <to>直播内容100个中偏好</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>直播内容100个中偏好</from>
      <to>直播内容100个重偏好</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>2.直播时段偏好标签表</from>
      <to>当日收看各类APP信息情况表</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>N</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>1.用户活跃信息基础标签表</from>
      <to>用户画像 分时段内容偏好标签</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>用户画像 分时段内容偏好标签</from>
      <to>用户画像 分时段epg栏目top偏好</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>用户画像 分时段epg栏目top偏好</from>
      <to>用户特征</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>用户特征</from>
      <to>用户分时段评分明细表</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>用户分时段评分明细表</from>
      <to>用户分时段总评分表</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>用户分时段总评分表</from>
      <to>用户画像</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
  </hops>
  <notepads>
  </notepads>
  <attributes>
    <group>
      <name>METASTORE.pentaho</name>
      <attribute>
        <key>Default Run Configuration</key>
        <value>{"namespace":"pentaho","id":"Default Run Configuration","name":"Default Run Configuration","description":"Defines a default run configuration","metaStoreName":null}</value>
      </attribute>
    </group>
    <group>
      <name>{"_":"Embedded MetaStore Elements","namespace":"pentaho","type":"Default Run Configuration"}</name>
      <attribute>
        <key>Pentaho local</key>
        <value>{"children":[{"children":[],"id":"server","value":null},{"children":[],"id":"clustered","value":"N"},{"children":[],"id":"name","value":"Pentaho local"},{"children":[],"id":"description","value":null},{"children":[],"id":"readOnly","value":"Y"},{"children":[],"id":"sendResources","value":"N"},{"children":[],"id":"logRemoteExecutionLocally","value":"N"},{"children":[],"id":"remote","value":"N"},{"children":[],"id":"local","value":"Y"},{"children":[],"id":"showTransformations","value":"N"}],"id":"Pentaho local","value":null,"name":"Pentaho local","owner":null,"ownerPermissionsList":[]}</value>
      </attribute>
    </group>
  </attributes>
</job>
